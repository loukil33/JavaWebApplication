<!DOCTYPE html>
<html style="font-size: 16px;" lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Rent your own bicycle​">
    <meta name="description" content="">
    <title>Home</title>
    <link rel="stylesheet" href="css/nicepage.css" media="screen">
<link rel="stylesheet" href="css/index.css" media="screen">
    <script class="u-script" type="text/javascript" src="css/js/jquery.js" defer=""></script>
    <script class="u-script" type="text/javascript" src="css/js/nicepage.js" defer=""></script>
    <meta name="generator" content="Nicepage 7.0.3, nicepage.com">
    <link id="u-theme-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i|Open+Sans:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i">
    <link id="u-page-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=ADLaM+Display:400">
    
<style>
/* General Layout Styles */
#sales-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
}

.sale-card {
    width: 30%;
    max-width: 300px;
    border: 1px solid #ddd;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    background-color: #fff;
    text-align: center;
    padding: 15px;
}

.sale-card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
}

.sale-card h3 {
    font-size: 1.2em;
    margin: 10px 0;
}

.sale-card p {
    margin: 5px 0;
    font-size: 0.9em;
    color: #555;
}

.sale-card button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 10px 15px;
    margin-top: 10px;
    border-radius: 5px;
    cursor: pointer;
}

.sale-card button:hover {
    background-color: #45a049;
}

/* Navbar and Logo Styles */
.navbar {
    display: flex;
    justify-content: space-between; /* Space between logo and navigation links */
    align-items: center; /* Vertically center the items */
    padding: 10px 20px;
}

.u-logo {
    margin-right: 20px; /* Adjust space between the logo and the nav */
    margin-left: -10px; /* Move the logo slightly to the left */
}

.u-logo-image {
    max-height: 100px; /* Adjust the height for better scaling */
    object-fit: contain; /* Fit the image within its container */
    margin-top: 45px;
}

.u-nav {
    display: flex; /* Keep the nav links in a row */
    justify-content: center;
    align-items: center;
    list-style: none;
    padding: 0;
    margin: 0;
}

.u-nav-item {
    margin: 0 10px;
}

.u-nav-link {
    text-decoration: none;
    padding: 10px 20px;
    color: black;
}

.u-nav-link:hover {
    color: blue;
}

/* Hidden Elements */
.hidden {
    display: none;
}

/* Check Cart Button and Badge Styles */
.cart-button-container {
    position: relative;
    display: inline-block;
}

.cart-button {
    background-color: #FFA726; /* Light orange */
    color: #FFFFFF; /* White text */
    border: 2px solid transparent; /* Initially no visible border */
    border-radius: 15px; /* Rounded corners */
    padding: 10px 20px;
    cursor: pointer;
    font-size: 14px;
    position: relative; /* To position badge correctly */
    transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, border-color 0.3s ease; /* Smooth hover effects */
}

.cart-button:hover {
    background-color: #FFFFFF; /* White background */
    color: #1E88E5; /* Blue text */
    border-color: #1E88E5; /* Blue border */
    transform: scale(1.05); /* Slight enlargement */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Add a shadow */
}

/* Badge styles for cart button */
.badge {
    display: inline-block;
    background-color: #FF3D00; /* Red for badge */
    color: #FFFFFF; /* White text */
    border-radius: 50%;
    font-size: 12px;
    padding: 4px 8px;
    position: absolute;
    top: -5px;
    right: -5px;
    border: 2px solid white; /* Border to make badge distinct */
    font-weight: bold; /* Bold text */
}

.badge.hidden {
    display: none; /* Hide the badge when no items in the cart */
}

/* Additional Form Adjustments */
form#rental-post-update-form {
    margin-top: 0;
}

h2.u-text-1 {
    margin-bottom: 0;
}
</style>

    <script type="application/ld+json">{
		"@context": "http://schema.org",
		"@type": "Organization",
		"name": "",
		"logo": "css/images/universite-gustave-eiffel.png"
}</script>
    <meta name="theme-color" content="#478ac9">
    <meta property="og:title" content="Home">
    <meta property="og:type" content="website">
  <meta data-intl-tel-input-cdn-path="intlTelInput/"></head>
<body class="u-body u-xl-mode" data-lang="en">
    <!-- Header Section from index.html -->
    <header class="u-clearfix u-grey-5 u-header u-header" id="sec-4073">
  <div class="u-clearfix u-sheet u-valign-middle-xs u-sheet-1">
           
            <nav class="navbar">
   <a href="#" class="u-image u-logo u-image-1" data-image-width="300" data-image-height="150">
    <img src="css/images/universite-gustave-eiffel.png" class="u-logo-image u-logo-image-1" alt="Université Gustave Eiffel Logo" style="width: auto; height: auto;">
</a>
    <ul class="u-nav u-unstyled u-nav-1">
        <li class="u-nav-item" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="index.html" style="padding: 10px 20px; margin-left: 80px;">Home</a></li>
        <li class="u-nav-item" id="profile-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="Sales.html" style="padding: 10px 20px;">Sales</a></li>
        <li class="u-nav-item" id="Bikes-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="MyBikes.html" style="padding: 10px 20px;">My Bikes</a></li>
        <li class="u-nav-item" id="posts-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="Annonces.html" style="padding: 10px 20px;">My Posts</a></li>
        <li class="u-nav-item" id="rentals-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="MyRentals.html" style="padding: 10px 20px;">My Rentals</a></li>
        <li class="u-nav-item" id="logout-link" style="display: none;">
            <button id="logout-btn" class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
                Logout
            </button>
        </li>
        <li class="u-nav-item" style="margin-left: 80px;">
        <button id="login-btn" class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
             Login
            </button>
            </li>
    </ul>
    <div id="user-info" style="display: none; margin-left: 20px; display: flex; align-items: center;">
    <h5 class="u-text u-text-default u-text-1" id="welcome-message"></h5>
    </div>
</nav>
           
        </div>
    </header>

    <!-- Main Content for Sales Page -->
  

    <section class="u-clearfix u-container-align-center-lg u-container-align-center-md u-container-align-center-xl u-container-align-center-xs u-palette-1-light-3 u-section-2" id="sales-section">
    <div style="display: flex; justify-content: center; align-items: center; margin-top: 10px;">
    <button class="cart-button u-align-center u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1" style="margin: 2px; margin-right: 5px;" onclick="checkCartBeforeNavigation()">
                Check Cart 
                <div id="cart-badge" class="badge hidden">0</div>
      </button>
            
     
           <a href="BuyHistory.html" class="u-align-center u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1" style="margin: 2px; margin-right: 5px;">Buy History</a>
           <label for="currency">Select Currency:</label>
        <select id="currency" onchange="convertPrices()">
            <!-- Currencies will be populated dynamically -->
        </select>
        </div>
    <div class="u-clearfix u-sheet u-sheet-1">
      <div class="u-expanded-width u-list u-list-1">
        <div class="u-repeater u-repeater-1" id="sales-container">
            <!-- Sales cards will be dynamically loaded here -->
        </div>
      </div>
      </div>
    </section>

    

    <script>
	    const BASE_CURRENCY = "EUR";
	    const userId = 1; // Example user ID
	    let conversionRates = {};
	    let salesData = [];

        async function fetchAndDisplaySales() {
            try {
                const response = await fetch("http://localhost:8081/UserWebService/api/sales");
                if (!response.ok) throw new Error("Failed to fetch sales data.");

                salesData = await response.json();
                displaySales(salesData);
                fetchCurrencyRates();
            } catch (error) {
                console.error("Error fetching sales:", error);
                document.getElementById("sales-container").innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        function displaySales(sales) {
            const container = document.getElementById("sales-container");
            container.innerHTML = "";

            if (!sales || sales.length === 0) {
                container.innerHTML = `<p>No sales available at the moment.</p>`;
                return;
            }

            sales.forEach((sale, index) => {
                try {
                    const bike = sale.bike || {}; // Ensure bike object exists
                    const imageUrl = bike.images && bike.images.length > 0 
                        ? bike.images[0] 
                        : 'http://localhost:8081/UserWebService/css/images/imagevelo.jpg';

                    const saleHTML = `
                        <div class="u-list-item u-radius u-repeater-item u-shape-round u-white u-list-item-1 sale-card" style="padding: auto; margin-bottom:auto;" data-animation-name="customAnimationIn" data-animation-duration="1500" data-animation-delay="200">
                        <div class="u-container-layout u-similar-container u-container-layout-1">
                            <img src="${imageUrl}" alt="Bike Image" class="u-expanded-width u-image u-image-round u-radius u-image-1" data-image-width="1067" data-image-height="800">
                            <h5 class="u-align-center u-text u-text-2">${sale.title || 'Unknown Sale'}</h5>
                            <p class="u-align-center u-text u-text-4">${sale.description || 'No description available'}</p>
                            <h4 class="u-align-center u-text u-text-palette-1-base u-text-3">€${(sale.salePrice || 0).toFixed(2)}</h4>
                            <p class="u-align-center u-text u-text-5"><strong>${bike.condition || 'Unknown Condition'}</strong> ${bike.model || 'Unknown Model'} | ${bike.brand || 'Unknown Brand'} | ${bike.color || 'Unknown Color'}</p>
                            <blockquote class="u-align-center u-indent-9 u-text u-text-6" style="font-size: 12px; margin-bottom: 10px; color: #888;">Sale ends in ${sale.duration || 0} days</blockquote>
                            <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
                            <button onclick="addToCart(${sale.id}, '${bike.model || 'Unknown Model'}', ${sale.salePrice || 0}, '${imageUrl}')" 
                                class="u-active-white u-align-center u-border-2 u-border-active-palette-1-base u-border-hover-palette-1-base u-border-palette-1-base u-btn u-btn-round u-button-style u-hover-white u-palette-1-base u-radius u-text-active-black u-text-body-alt-color u-text-hover-black u-btn-1" 
                                style="margin: 2px; margin-right: 5px; padding: 10px 5px;">
                                Add to Cart
                            </button>

                            </div>
                        </div>
                    </div>`;
                    container.innerHTML += saleHTML;
                } catch (error) {
                    console.error(`Error rendering sale at index ${index}:`, error);
                }
            });
        }

        
        async function addToCart(saleId, model, price, image) {
            try {
                const sale = { id: saleId, model, salePrice: price, bike: { model, images: [image] } };
                const response = await fetch(`http://localhost:8081/UserWebService/api/cart/add?userId=${userId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(sale),
                });
                if (response.ok) {
                    alert("Item added to cart successfully!");
                    updateCartBadge();
                } else if (response.status === 400) {
                    const errorText = await response.text();
                    if (errorText.includes("already in cart")) alert("This item is already in your cart.");
                } else {
                    throw new Error("Failed to add item.");
                }
            } catch (error) {
                console.error("Error adding to cart:", error);
            }
        }

        async function checkCartBeforeNavigation() {
            try {
                const response = await fetch(`http://localhost:8081/UserWebService/api/cart/items?userId=${userId}`);
                const data = await response.json();
                if (data.cartItems.length === 0) {
                    alert("Your cart is empty.");
                } else {
                    window.location.href = "BuyCart.html";
                }
            } catch (error) {
                console.error("Error checking cart:", error);
            }
        }

        async function updateCartBadge() {
            try {
                const response = await fetch(`http://localhost:8081/UserWebService/api/cart/items?userId=${userId}`);
                const data = await response.json();
                const badge = document.getElementById("cart-badge");
                if (data.cartItems.length > 0) {
                    badge.textContent = data.cartItems.length;
                    badge.classList.remove("hidden");
                } else {
                    badge.classList.add("hidden");
                }
            } catch (error) {
                console.error("Error updating badge:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            fetchAndDisplaySales();
            updateCartBadge();
        });
        
        async function fetchCurrencyRates() {
            try {
                const response = await fetch("https://v6.exchangerate-api.com/v6/b799283f68d4ffc21668f606/latest/EUR");
                if (!response.ok) throw new Error("Failed to fetch currency rates.");

                const data = await response.json();
                conversionRates = data.conversion_rates;

                populateCurrencyDropdown(Object.keys(conversionRates));
            } catch (error) {
                console.error("Error fetching currency rates:", error);
            }
        }

        function populateCurrencyDropdown(currencies) {
            const dropdown = document.getElementById("currency");
            dropdown.innerHTML = "";

            currencies.forEach(currency => {
                const option = document.createElement("option");
                option.value = currency;
                option.textContent = currency;
                dropdown.appendChild(option);
            });

            dropdown.value = BASE_CURRENCY;
        }

        function convertPrices() {
            const selectedCurrency = document.getElementById("currency").value;
            const prices = document.querySelectorAll(".price");

            prices.forEach(priceElement => {
                const basePrice = parseFloat(priceElement.getAttribute("data-price"));
                const convertedPrice = (basePrice * conversionRates[selectedCurrency]).toFixed(2);
                priceElement.textContent = `${selectedCurrency} ${convertedPrice}`;
            });
        }

   
        document.addEventListener('DOMContentLoaded', () => {
            // Safely retrieve user data from session storage
            const userDataJson = sessionStorage.getItem("userData");
            let userData = null;

            try {
                userData = JSON.parse(userDataJson);
            } catch (error) {
                console.error("Error parsing user data:", error);
            }

            if (userData) {
                console.log("User data found in session:", userData);
                const loginBtn = document.getElementById('login-btn');
                const logoutBtn = document.getElementById('logout-link');
                const profileLink = document.getElementById('profile-link');
                const postsLink = document.getElementById('posts-link');
                const bikesLink = document.getElementById('Bikes-link');
                const rentalsLink = document.getElementById('rentals-link');
                const homeLink = document.getElementById('home-link');
                const welcomeMessage = document.getElementById('welcome-message');

                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'block';

                // Safely access and update DOM elements
                if (userData.role === "CLIENT") {
                if (homeLink) homeLink.style.display = 'none';
                if (profileLink) profileLink.style.display = 'none';
                if (postsLink) postsLink.style.display = 'none';
                if (bikesLink) bikesLink.style.display = 'none';
                if (rentalsLink) rentalsLink.style.display = 'none';
            } else {
                // For other roles, show all links
                if (homeLink) homeLink.style.display = 'block';
                if (profileLink) profileLink.style.display = 'block';
                if (postsLink) postsLink.style.display = 'block';
                if (bikesLink) bikesLink.style.display = 'block';
                if (rentalsLink) rentalsLink.style.display = 'block';
            }
                if (welcomeMessage) welcomeMessage.textContent = `Welcome, ${userData.first_name}`;
                
                fetch( `http://localhost:8081/UserWebService/api/annonces/` 
        		)
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to fetch annonces.");
            }
            return response.json();
        })
        .then(annonces => {
            displayAnnoncesHome(annonces);
        })
        .catch(error => {
            console.error("Error fetching annonces:", error);
            document.getElementById('annonces-container-home').innerHTML = `
                <p style="color: red;">Unable to load your posts. Please try again later.</p>
                `;
        });
                
            } else {
                console.log("No user data found in session.");
            }

            // Handle login button click
            const loginButton = document.getElementById('login-btn');
            if (loginButton) {
                loginButton.addEventListener('click', () => {
                    window.location.href = "Login-Page.html";
                });
            }
            const logoutButton = document.getElementById('logout-btn');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    
                    sessionStorage.clear();
                    localStorage.clear();   
                    
                    window.location.href = "Login-Page.html";
                });
            }

        });
        function displayAnnoncesHome(annonces) {
            const container = document.getElementById('annonces-container-home');
            let username = null;
            container.innerHTML = ''; // Clear existing content

            if (annonces.length === 0) {
                container.innerHTML = '<p>No posts found.</p>';
                return;
            }
            
            annonces.forEach(annonce => {
            	const userDataJson = sessionStorage.getItem("userData");
                let userData = null;

                try {
                    userData = JSON.parse(userDataJson);
                } catch (error) {
                    console.error("Error parsing user data:", error);
                }
            	if(userData){
            		
            		if (annonce.userid === userData.id) {
                		//container.innerHTML = '<p>No posts found.</p>';
                        return;
                    }
            		let additionalInfo = "";
                    fetch(`http://localhost:8081/UserWebService/api/users/${annonce.userid}`
            		)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch username.");
                    }
                    return response.json();
                })
                .then(user => {
                    // Rebuild the user's annonces list from the API response
                	const username = user.last_name;
                	
                	if ("rentPrice" in annonce) {
                        additionalInfo = `
                            <h4 class="u-align-center u-text u-text-palette-1-base u-text-3">${annonce.rentPrice} €/h</h4>
                            <p class="u-align-center u-text u-text-4"><strong>${annonce.bike.condition}</strong> ${annonce.bike.model} | ${annonce.bike.brand} | ${annonce.bike.color}</p>
                            <p class="u-align-center u-text u-text-5">
                                <span class="u-file-icon u-icon u-icon-1">
                                    <img src="css/images/1584892.png" alt="" style="width: 20px; height: 20px; margin-bottom: 8px">
                                </span>&nbsp;Rent Time: ${annonce.start_time} - ${annonce.end_time}
                            </p>`;
                    }
                	const imageUrl = annonce.bike.images && annonce.bike.images.length > 0 
                    ? annonce.bike.images[0] 
                    : 'http://localhost:8081/UserWebService/css/images/imagevelo.jpg';
                    const annonceHTML = `
                        <div class="u-list-item u-radius u-repeater-item u-shape-round u-white u-list-item-1" style="padding: auto;  margin-bottom:auto;" data-animation-name="customAnimationIn" data-animation-duration="1500" data-animation-delay="200">
                            <div class="u-container-layout u-similar-container u-container-layout-1">
                                <img src="${imageUrl}" alt="" class="u-expanded-width u-image u-image-round u-radius u-image-1" data-image-width="1067" data-image-height="800">
                                <h5 class="u-align-center u-text u-text-2">${annonce.title}</h5>
                                <p class="u-align-center u-text u-text-4">${annonce.description}</p>
                                ${additionalInfo}
                                <blockquote class="u-align-center u-indent-9 u-text u-text-6" style="font-size: 12px; margin-bottom: 10px; color: #888;">Posted By ${username} ends in ${annonce.duration} days</blockquote>
                                <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
                                <a href="#" onclick="viewAnnonceDetails( ${annonce.id} )" class="u-active-white u-align-center u-border-2 u-border-active-palette-1-base u-border-hover-palette-1-base u-border-palette-1-base u-btn u-btn-round u-button-style u-hover-white u-palette-1-base u-radius u-text-active-black u-text-body-alt-color u-text-hover-black u-btn-1" style="margin: 2px; margin-right: 5px padding: 10px 5px;" data-animation-name="" data-animation-duration="0" data-animation-delay="0" data-animation-direction="">Rent Bike</a>
                                    
                                </div>
                            </div>
                        </div>
                    `;

                    container.innerHTML += annonceHTML;
                })
                .catch(error => {
                    console.error("Error fetching username:", error);
                   
                });
                    
            	}

                // Check if the annonce has rental-specific properties
            });
        }
    </script>
    <footer class="u-align-center u-clearfix u-footer" id="footer">
    <div class="u-clearfix u-sheet u-sheet-1">
        <p>Eiffel Corp &copy; 2024. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>
