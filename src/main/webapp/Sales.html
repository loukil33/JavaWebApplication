<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Page</title>
    <link rel="stylesheet" href="css/nicepage.css">
    <link rel="stylesheet" href="css/index.css">
    <style>
        /* Sales page specific styling */
        #sales-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .sale-card {
            width: 30%;
            max-width: 300px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            text-align: center;
            padding: 15px;
        }

        .sale-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
        }

        .sale-card h3 {
            font-size: 1.2em;
            margin: 10px 0;
        }

        .sale-card p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #555;
        }

        .sale-card button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .sale-card button:hover {
            background-color: #45a049;
        }

        /* Styling for cart button and badge */
        .cart-button-container {
            position: relative;
            display: inline-block;
        }

        .cart-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            position: relative;
        }

        .cart-button:hover {
            background-color: #45a049;
        }

        .badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: red;
            color: white;
            border-radius: 50%;
            font-size: 14px;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 2px solid white;
        }

        .badge.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header Section from index.html -->
    <header class="u-clearfix u-grey-5 u-header u-header" id="sec-4073">
        <div class="u-clearfix u-sheet u-valign-middle-xs u-sheet-1">
            <nav class="navbar">
                <a href="#" class="u-image u-logo u-image-1" data-image-width="300" data-image-height="150">
                    <img src="css/images/universite-gustave-eiffel.png" class="u-logo-image u-logo-image-1" alt="UniversitÃ© Gustave Eiffel Logo" style="width: auto; height: auto;">
                </a>
                <ul class="u-nav u-unstyled u-nav-1">
                    <li class="u-nav-item"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="index.html" style="padding: 10px 20px; margin-left: 80px;">Home</a></li>
                    <li class="u-nav-item" id="profile-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="Sales.html" style="padding: 10px 20px;">Sales</a></li>
                    <li class="u-nav-item" id="Bikes-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="MyBikes.html" style="padding: 10px 20px;">My Bikes</a></li>
                    <li class="u-nav-item" id="posts-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="Annonces.html" style="padding: 10px 20px;">My Posts</a></li>
                    <li class="u-nav-item" id="rentals-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="Page-1.html" style="padding: 10px 20px;">My Rentals</a></li>
                    <li class="u-nav-item" id="logout-link" style="display: none;">
                        <button id="logout-btn" class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
                            Logout
                        </button>
                    </li>
                    <li class="u-nav-item" style="margin-left: 80px;">
                        <button id="login-btn" class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
                            Login
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content for Sales Page -->
    <section style="padding: 20px; text-align: center;">
        <div class="cart-button-container">
            <button class="cart-button" onclick="checkCartBeforeNavigation()">
                ðŸ›’ Check Cart
                <div id="cart-badge" class="badge hidden">0</div>
            </button>
           <a href="BuyHistory.html" class="cart-button">Buy History</a>

        </div>
        <label for="currency">Select Currency:</label>
        <select id="currency" onchange="convertPrices()">
            <!-- Currencies will be populated dynamically -->
        </select>
    </section>

    <section id="sales-section">
        <div id="sales-container">
            <!-- Sales cards will be dynamically loaded here -->
        </div>
    </section>

    <footer class="u-align-center u-footer u-footer" id="footer">
        <p class="u-small-text u-text u-text-variant u-text-1">Eiffel Corp &copy; 2024. All rights reserved.</p>
    </footer>

    <script>
	    const BASE_CURRENCY = "EUR";
	    const userId = 1; // Example user ID
	    let conversionRates = {};
	    let salesData = [];

        async function fetchAndDisplaySales() {
            try {
                const response = await fetch("http://localhost:8081/UserWebService/api/sales");
                if (!response.ok) throw new Error("Failed to fetch sales data.");

                salesData = await response.json();
                displaySales(salesData);
                fetchCurrencyRates();
            } catch (error) {
                console.error("Error fetching sales:", error);
                document.getElementById("sales-container").innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        function displaySales(sales) {
            const container = document.getElementById("sales-container");
            container.innerHTML = "";

            if (!sales || sales.length === 0) {
                container.innerHTML = `<p>No sales available at the moment.</p>`;
                return;
            }

            sales.forEach((sale, index) => {
                try {
                    const bike = sale.bike || {}; // Ensure bike object exists
                    const imageUrl = bike.images && bike.images.length > 0 
                        ? bike.images[0] 
                        : 'http://localhost:8081/UserWebService/css/images/imagevelo.jpg';

                    const saleHTML = `
                        <div class="sale-card">
                            <img src="${imageUrl}" alt="Bike Image">
                            <h3>${sale.title || 'Unknown Sale'}</h3>
                            <p>${sale.description || 'No description available'}</p>
                            <p><strong>Price:</strong> <span data-price="${sale.salePrice || 0}" class="price">â‚¬${(sale.salePrice || 0).toFixed(2)}</span></p>
                            <p><strong>Start Date:</strong> ${sale.startDate || 'N/A'}</p>
                            <p><strong>Duration:</strong> ${sale.duration || 0} days</p>
                            <p><strong>Bike:</strong> ${bike.model || 'Unknown Model'} (${bike.brand || 'Unknown Brand'}, ${bike.color || 'Unknown Color'})</p>
                            <button onclick="addToCart(${sale.id}, '${bike.model || 'Unknown Model'}', ${sale.salePrice || 0}, '${imageUrl}')">Add to Cart</button>
                        </div>`;
                    container.innerHTML += saleHTML;
                } catch (error) {
                    console.error(`Error rendering sale at index ${index}:`, error);
                }
            });
        }

        
        async function addToCart(saleId, model, price, image) {
            try {
                const sale = { id: saleId, model, salePrice: price, bike: { model, images: [image] } };
                const response = await fetch(`http://localhost:8081/UserWebService/api/cart/add?userId=${userId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(sale),
                });
                if (response.ok) {
                    alert("Item added to cart successfully!");
                    updateCartBadge();
                } else if (response.status === 400) {
                    const errorText = await response.text();
                    if (errorText.includes("already in cart")) alert("This item is already in your cart.");
                } else {
                    throw new Error("Failed to add item.");
                }
            } catch (error) {
                console.error("Error adding to cart:", error);
            }
        }

        async function checkCartBeforeNavigation() {
            try {
                const response = await fetch(`http://localhost:8081/UserWebService/api/cart/items?userId=${userId}`);
                const data = await response.json();
                if (data.cartItems.length === 0) {
                    alert("Your cart is empty.");
                } else {
                    window.location.href = "BuyCart.html";
                }
            } catch (error) {
                console.error("Error checking cart:", error);
            }
        }

        async function updateCartBadge() {
            try {
                const response = await fetch(`http://localhost:8081/UserWebService/api/cart/items?userId=${userId}`);
                const data = await response.json();
                const badge = document.getElementById("cart-badge");
                if (data.cartItems.length > 0) {
                    badge.textContent = data.cartItems.length;
                    badge.classList.remove("hidden");
                } else {
                    badge.classList.add("hidden");
                }
            } catch (error) {
                console.error("Error updating badge:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            fetchAndDisplaySales();
            updateCartBadge();
        });
        
        async function fetchCurrencyRates() {
            try {
                const response = await fetch("https://v6.exchangerate-api.com/v6/b799283f68d4ffc21668f606/latest/EUR");
                if (!response.ok) throw new Error("Failed to fetch currency rates.");

                const data = await response.json();
                conversionRates = data.conversion_rates;

                populateCurrencyDropdown(Object.keys(conversionRates));
            } catch (error) {
                console.error("Error fetching currency rates:", error);
            }
        }

        function populateCurrencyDropdown(currencies) {
            const dropdown = document.getElementById("currency");
            dropdown.innerHTML = "";

            currencies.forEach(currency => {
                const option = document.createElement("option");
                option.value = currency;
                option.textContent = currency;
                dropdown.appendChild(option);
            });

            dropdown.value = BASE_CURRENCY;
        }

        function convertPrices() {
            const selectedCurrency = document.getElementById("currency").value;
            const prices = document.querySelectorAll(".price");

            prices.forEach(priceElement => {
                const basePrice = parseFloat(priceElement.getAttribute("data-price"));
                const convertedPrice = (basePrice * conversionRates[selectedCurrency]).toFixed(2);
                priceElement.textContent = `${selectedCurrency} ${convertedPrice}`;
            });
        }

   
        document.addEventListener('DOMContentLoaded', () => {
            // Safely retrieve user data from session storage
            const userDataJson = sessionStorage.getItem("userData");
            let userData = null;

            try {
                userData = JSON.parse(userDataJson);
            } catch (error) {
                console.error("Error parsing user data:", error);
            }

            if (userData) {
                console.log("User data found in session:", userData);

                // Safely access and update DOM elements
                const loginBtn = document.getElementById('login-btn');
                const logoutBtn = document.getElementById('logout-link');
                const profileLink = document.getElementById('profile-link');
                const postsLink = document.getElementById('posts-link');
                const bikesLink = document.getElementById('Bikes-link');
                const rentalsLink = document.getElementById('rentals-link');
                const welcomeMessage = document.getElementById('welcome-message');

                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'block';
                if (profileLink) profileLink.style.display = 'block';
                if (postsLink) postsLink.style.display = 'block';
                if (bikesLink) bikesLink.style.display = 'block';
                if (rentalsLink) rentalsLink.style.display = 'block';
                if (welcomeMessage) welcomeMessage.textContent = `Welcome, ${userData.first_name}`;
                
                fetch( `http://localhost:8081/UserWebService/api/annonces/` 
        		)
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to fetch annonces.");
            }
            return response.json();
        })
        .then(annonces => {
            displayAnnoncesHome(annonces);
        })
        .catch(error => {
            console.error("Error fetching annonces:", error);
            document.getElementById('annonces-container-home').innerHTML = `
                <p style="color: red;">Unable to load your posts. Please try again later.</p>
                `;
        });
                
            } else {
                console.log("No user data found in session.");
            }

            // Handle login button click
            const loginButton = document.getElementById('login-btn');
            if (loginButton) {
                loginButton.addEventListener('click', () => {
                    window.location.href = "Login-Page.html";
                });
            }
            const logoutButton = document.getElementById('logout-btn');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    
                    sessionStorage.clear();
                    localStorage.clear();   
                    
                    window.location.href = "Login-Page.html";
                });
            }

        });
        function displayAnnoncesHome(annonces) {
            const container = document.getElementById('annonces-container-home');
            let username = null;
            container.innerHTML = ''; // Clear existing content

            if (annonces.length === 0) {
                container.innerHTML = '<p>No posts found.</p>';
                return;
            }
            
            annonces.forEach(annonce => {
            	const userDataJson = sessionStorage.getItem("userData");
                let userData = null;

                try {
                    userData = JSON.parse(userDataJson);
                } catch (error) {
                    console.error("Error parsing user data:", error);
                }
            	if(userData){
            		
            		if (annonce.userid === userData.id) {
                		//container.innerHTML = '<p>No posts found.</p>';
                        return;
                    }
            		let additionalInfo = "";
                    fetch(`http://localhost:8081/UserWebService/api/users/${annonce.userid}`
            		)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch username.");
                    }
                    return response.json();
                })
                .then(user => {
                    // Rebuild the user's annonces list from the API response
                	const username = user.last_name;
                	
                	if ("rentPrice" in annonce) {
                        additionalInfo = `
                            <h4 class="u-align-center u-text u-text-palette-1-base u-text-3">${annonce.rentPrice} â‚¬/h</h4>
                            <p class="u-align-center u-text u-text-4"><strong>${annonce.bike.condition}</strong> ${annonce.bike.model} | ${annonce.bike.brand} | ${annonce.bike.color}</p>
                            <p class="u-align-center u-text u-text-5">
                                <span class="u-file-icon u-icon u-icon-1">
                                    <img src="css/images/1584892.png" alt="" style="width: 20px; height: 20px; margin-bottom: 8px">
                                </span>&nbsp;Rent Time: ${annonce.start_time} - ${annonce.end_time}
                            </p>`;
                    }
                	const imageUrl = annonce.bike.images && annonce.bike.images.length > 0 
                    ? annonce.bike.images[0] 
                    : 'http://localhost:8081/UserWebService/css/images/imagevelo.jpg';
                    const annonceHTML = `
                        <div class="u-list-item u-radius u-repeater-item u-shape-round u-white u-list-item-1" style="padding: auto;  margin-bottom:auto;" data-animation-name="customAnimationIn" data-animation-duration="1500" data-animation-delay="200">
                            <div class="u-container-layout u-similar-container u-container-layout-1">
                                <img src="${imageUrl}" alt="" class="u-expanded-width u-image u-image-round u-radius u-image-1" data-image-width="1067" data-image-height="800">
                                <h5 class="u-align-center u-text u-text-2">${annonce.title}</h5>
                                <p class="u-align-center u-text u-text-4">${annonce.description}</p>
                                ${additionalInfo}
                                <blockquote class="u-align-center u-indent-9 u-text u-text-6" style="font-size: 12px; margin-bottom: 10px; color: #888;">Posted By ${username} ends in ${annonce.duration} days</blockquote>
                                <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
                                <a href="#" onclick="viewAnnonceDetails( ${annonce.id} )" class="u-active-white u-align-center u-border-2 u-border-active-palette-1-base u-border-hover-palette-1-base u-border-palette-1-base u-btn u-btn-round u-button-style u-hover-white u-palette-1-base u-radius u-text-active-black u-text-body-alt-color u-text-hover-black u-btn-1" style="margin: 2px; margin-right: 5px padding: 10px 5px;" data-animation-name="" data-animation-duration="0" data-animation-delay="0" data-animation-direction="">Rent Bike</a>
                                    
                                </div>
                            </div>
                        </div>
                    `;

                    container.innerHTML += annonceHTML;
                })
                .catch(error => {
                    console.error("Error fetching username:", error);
                   
                });
                    
            	}

                // Check if the annonce has rental-specific properties
            });
        }
    </script>
</body>
</html>
