<!DOCTYPE html>
<html style="font-size: 16px;" lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Rent your own bicycle​">
    <meta name="description" content="">
    <title>My Bikes</title>
    <link rel="stylesheet" href="css/nicepage.css" media="screen">
    <link rel="stylesheet" href="css/index.css" media="screen">
    <script class="u-script" type="text/javascript" src="css/js/jquery.js" defer=""></script>
    <script class="u-script" type="text/javascript" src="css/js/nicepage.js" defer=""></script>
    <meta name="generator" content="Nicepage 7.0.3, nicepage.com">
    <link id="u-theme-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i|Open+Sans:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i">
    <meta name="theme-color" content="#478ac9">
    <meta property="og:title" content="My Bikes">
    <meta property="og:type" content="website">
</head>

<body class="u-body u-xl-mode" data-lang="en">
    <header class="u-clearfix u-grey-5 u-header u-header" id="sec-4073">
        <div class="u-clearfix u-sheet u-valign-middle-xs u-sheet-1">
            <a href="#" class="u-image u-logo u-image-1" data-image-width="300" data-image-height="150">
                <img src="css/images/universite-gustave-eiffel.png" class="u-logo-image u-logo-image-1">
            </a>
            <nav class="u-menu u-menu-one-level u-offcanvas u-menu-1">
                <div class="menu-collapse" style="font-size: 1.125rem;">
                    <a class="u-button-style u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="#">
                        <svg class="u-svg-link" viewBox="0 0 24 24">
                            <use xlink:href="#menu-hamburger"></use>
                        </svg>
                        <svg class="u-svg-content" version="1.1" id="menu-hamburger" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <g>
                                <rect y="1" width="16" height="2"></rect>
                                <rect y="7" width="16" height="2"></rect>
                                <rect y="13" width="16" height="2"></rect>
                            </g>
                        </svg>
                    </a>
                </div>
            </nav>
            <button id="login-btn" class="u-btn u-btn-round u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
                Login
            </button>
        </div>
    </header>

    <section class="u-clearfix u-container-align-center-lg u-container-align-center-md u-container-align-center-xl u-container-align-center-xs u-palette-1-light-3 u-section-2" id="bikes-section">
        <a class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1" href="AddBike.html">+ Add New Bike</a>

        <div class="u-clearfix u-sheet u-sheet-1">
            <div class="u-expanded-width u-list u-list-1">
                <div class="u-repeater u-repeater-1" id="bikes-container">
                    <!-- Bikes will be displayed here -->
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userDataJson = sessionStorage.getItem("userData");
            let userData = null;

            try {
                userData = JSON.parse(userDataJson); // Parse user data from session
            } catch (error) {
                console.error("Error parsing user data:", error);
                return;
            }

            if (userData) {
                const userId = userData.id; // Retrieve user ID from session data

                // Fetch bikes for the user
                fetch(`http://localhost:8081/UserWebService/api/users/${userId}/bikes`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Failed to fetch bikes.");
                        }
                        return response.json();
                    })
                    .then(bikes => {
                    	sessionStorage.setItem("bikes", JSON.stringify(bikes)); 
                        displayBikes(bikes);
                    })
                    .catch(error => {
                        console.error("Error fetching bikes:", error);
                        document.getElementById('bikes-container').innerHTML = `
                            <p style="color: red;">Unable to load your bikes. Please try again later.</p>`;
                    });
            } else {
                console.error("No user data found in session.");
            }
        });

        function displayBikes(bikes) {
            const container = document.getElementById('bikes-container');
            container.innerHTML = ''; // Clear existing content

            if (bikes.length === 0) {
                container.innerHTML = '<p>No bikes found for this account.</p>';
                return;
            }

            bikes.forEach(bike => {
                const imageUrl = bike.images && bike.images.length > 0 
                    ? bike.images[0] 
                    : 'http://localhost:8081/UserWebService/css/images/imagevelo.jpg';

                const bikeHTML = `
                    <div class="u-list-item u-radius u-repeater-item u-shape-round u-white u-list-item-1">
                        <div class="u-container-layout u-similar-container u-container-layout-1">
                            <img src="${imageUrl}" 
                                alt="Bike Image" 
                                class="u-expanded-width u-image u-image-round u-radius u-image-1" 
                                style="height: 200px; object-fit: cover;">
                            
                            <h5 class="u-align-center u-text u-text-3">${bike.model}</h5>
                            <p class="u-align-center u-text u-text-4">Brand: ${bike.brand}</p>
                            <p class="u-align-center u-text u-text-5">Condition: ${bike.condition}</p>
                            <p class="u-align-center u-text u-text-6">Color: ${bike.color}</p>

                            <a href="EditBike.html" onclick="editBike(${bike.id})" 
                               class="u-btn u-btn-round u-button-style u-hover-custom-color-1 u-radius u-btn-2">
                                Edit Bike
                            </a>
                                
                            <!-- Delete Button -->
                            <button onclick="deleteBike(${bike.id})" 
                                class="u-btn u-btn-round u-button-style u-hover-custom-color-1 u-radius u-btn-3" style="margin-left: 10px;">
                                Delete Bike
                            </button> 
                        </div>
                    </div>`;
                container.innerHTML += bikeHTML;
            });
        }

        function editBike(bikeId) {
            // Fetch the list of bikes from sessionStorage
            const bikesJson = sessionStorage.getItem("bikes");
            
            if (!bikesJson) {
                alert("No bikes found in session. Please reload the page.");
                return;
            }

            const bikes = JSON.parse(bikesJson);

            // Find the selected bike by its ID
            const selectedBike = bikes.find(bike => bike.id === bikeId);

            if (!selectedBike) {
                alert("Bike not found.");
                return;
            }

            // Save the selected bike's details in sessionStorage for use in the edit page
            sessionStorage.setItem("selectedBike", JSON.stringify(selectedBike));

            // Redirect to the EditBike.html page
            window.location.href = "EditBike.html";
        }
        
        function deleteBike(bikeId) {
            // Confirm if the user wants to delete the bike
            const confirmDelete = confirm("Are you sure you want to delete this bike?");
            if (!confirmDelete) {
                return; // Exit if user cancels the delete action
            }

            // Send DELETE request to the server to remove the bike
            fetch(`http://localhost:8081/UserWebService/api/bikes/${bikeId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                // If the response is not ok (e.g., not 200 status), throw an error
                if (!response.ok) {
                    throw new Error("Failed to delete the bike");
                }

                // Try to parse the response as JSON, if it fails, treat it as text
                return response.text();  // Since we expect a plain text response
            })
            .then(message => {
                alert(message);  // Show the message returned by the server

                // Update bikes in sessionStorage after deletion
                let bikes = JSON.parse(sessionStorage.getItem("bikes"));
                bikes = bikes.filter(bike => bike.id !== bikeId);  // Remove the deleted bike
                sessionStorage.setItem("bikes", JSON.stringify(bikes));  // Update sessionStorage with the new list

                // Refresh the UI to reflect the deleted bike
                displayBikes(bikes);
            })
            .catch(error => {
                console.error("Error deleting bike:", error);
                alert("Error deleting bike: " + error.message);
            });
        }



    </script>

    <footer class="u-align-center u-clearfix u-footer">
        <div class="u-clearfix u-sheet u-sheet-1">
            <p>© 2024 Your Company. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>
