<!DOCTYPE html>
<html style="font-size: 16px;" lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Rent your own bicycle​">
    <meta name="description" content="">
    <title>Home</title>
    <link rel="stylesheet" href="css/nicepage.css" media="screen">
<link rel="stylesheet" href="css/index.css" media="screen">
    <script class="u-script" type="text/javascript" src="css/js/jquery.js" defer=""></script>
    <script class="u-script" type="text/javascript" src="css/js/nicepage.js" defer=""></script>
    <meta name="generator" content="Nicepage 7.0.3, nicepage.com">
    <link id="u-theme-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i|Open+Sans:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i">
    <link id="u-page-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=ADLaM+Display:400">
    
      <style>
        body {
            font-family: Arial, sans-serif;
        }

        form {
            /*max-width: 600px;*/
            width: 1200px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input, textarea, button {
            width: 100%;
            padding: 8px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #0290e6;
            color: white;
            font-size: 16px;
        }

        button:hover {
            background-color: #0417b2;
        }
    </style>
    
    <style>
    .u-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    list-style: none;
    padding: 0;
    margin: 0;
}
.u-nav-item {
    margin: 0 10px;
}
.u-nav-link {
    text-decoration: none;
    padding: 10px 20px;
    color: black;
}
.u-nav-link:hover {
    color: blue;
}
.hidden {
    display: none;
}

h2.u-text-1 {
    margin-bottom: 0;
}

form#rental-post-update-form {
    margin-top: 0;
    
}
.navbar {
    display: flex;
    justify-content: space-between; /* Space between logo and navigation links */
    align-items: center; /* Vertically center the items */
    padding: 10px 20px;
}

/* Adjust the logo if necessary */
.u-logo {
    margin-right: 20px; /* Adjust space between the logo and the nav */
    margin-left: -10px; /* Move the logo slightly to the left */
}
.u-nav {
    display: flex; /* Keep the nav links in a row */
    list-style: none;
    padding: 0;
    margin: 0;
}

/* Ensure the logo image does not collapse */
.u-logo-image {
    max-height: 100px; /* Adjust the height for better scaling */
    max-width: auto; /* Ensure the aspect ratio is maintained */
    object-fit: contain; /* Fit the image within its container */
    margin-top: 45px;
}
.modal {
        display: none; 
        position: fixed; 
        z-index: 1; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgb(0,0,0); 
        background-color: rgba(0,0,0,0.4); 
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 400px;
    }

    .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    button {
        padding: 10px 15px;
        margin: 10px;
        background-color: #0290e6;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
    }

    button:hover {
        background-color: #0417b2;
    }

    .hidden {
        display: none;
    }
    
    
    </style>
    <script type="application/ld+json">{
		"@context": "http://schema.org",
		"@type": "Organization",
		"name": "",
		"logo": "css/images/universite-gustave-eiffel.png"
}</script>
    <meta name="theme-color" content="#478ac9">
    <meta property="og:title" content="Home">
    <meta property="og:type" content="website">
  <meta data-intl-tel-input-cdn-path="intlTelInput/"></head>


<body class="u-body u-xl-mode" data-lang="en">
    <header class="u-clearfix u-grey-5 u-header u-header" id="sec-4073">
  <div class="u-clearfix u-sheet u-valign-middle-xs u-sheet-1">
           
            <nav class="navbar">
   <a href="#" class="u-image u-logo u-image-1" data-image-width="300" data-image-height="150">
    <img src="css/images/universite-gustave-eiffel.png" class="u-logo-image u-logo-image-1" alt="Université Gustave Eiffel Logo" style="width: auto; height: auto;">
</a>
    <ul class="u-nav u-unstyled u-nav-1">
        <li class="u-nav-item"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="index.html" style="padding: 10px 20px; margin-left: 80px;">Home</a></li>
        <li class="u-nav-item" id="profile-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="Sales.html" style="padding: 10px 20px;">Sales</a></li>
        <li class="u-nav-item" id="Bikes-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="MyBikes.html" style="padding: 10px 20px;">My Bikes</a></li>
        <li class="u-nav-item" id="posts-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="Annonces.html" style="padding: 10px 20px;">My Posts</a></li>
        <li class="u-nav-item" id="rentals-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="MyRentals.html" style="padding: 10px 20px;">My Rentals</a></li>
        <li class="u-nav-item" id="logout-link" style="display: none;">
            <div style="display: flex; align-items: center; gap: 15px;">
        
        <button id="logout-btn" class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
            Logout
        </button>
        <button id="login-btn" class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
            Login
        </button>
        <h5 id="welcome-message" class="u-text u-text-default u-text-1" style="margin: auto; font-size: 20px;"></h5>
    </div>
    
            <!--  <button id="logout-btn" class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
                Logout
            </button>
        </li>
        <li class="u-nav-item" style="margin-left: 80px;">
        <button id="login-btn" class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
             Login
            </button>
            </li>-->
    </ul>
    <!--<div id="user-info" style="display: none; margin-left: 20px; display: flex; align-items: center;">
    <h5 class="u-text u-text-default u-text-1" id="welcome-message"></h5>
    </div>-->
</nav>
           
        </div>
    </header>

    <section class="u-clearfix u-container-align-center-lg u-container-align-center-md u-container-align-center-xl u-container-align-center-xs u-palette-1-light-3 u-section-2" id="bikes-section">
        <a class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1" href="AddBike.html">+ Add New Bike</a>

        <div class="u-clearfix u-sheet u-sheet-1">
            <div class="u-expanded-width u-list u-list-1">
                <div class="u-repeater u-repeater-1" id="bikes-container">
                    <!-- Bikes will be displayed here -->
                </div>
            </div>
        </div>
    </section>


<!-- The Modal -->
<div id="sell-modal" class="modal hidden">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3>Enter Sale Details</h3>

        <!-- Sale Title -->
        <label for="sale-title">Title</label>
        <input type="text" id="sale-title" placeholder="Enter sale title" required>

        <!-- Sale Description -->
        <label for="sale-description">Description</label>
        <textarea id="sale-description" placeholder="Enter sale description" required></textarea>

        <!-- Sale Start Date (hidden and set by script) -->
        <input type="hidden" id="sale-start-date">

        <!-- Sale Duration -->
        <label for="sale-duration">Duration (days)</label>
        <input type="number" id="sale-duration" placeholder="Enter duration in days" min="1" required>

        <!-- Sale Price -->
        <label for="sell-price">Sale Price (€)</label>
        <input type="number" id="sell-price" placeholder="Enter price" min="0" required>

        <!-- Confirm Sale -->
        <button id="confirm-sell-btn">Confirm</button>
    </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', () => {
    const userDataJson = sessionStorage.getItem("userData");
    let userData = null;

    try {
        userData = JSON.parse(userDataJson); // Parse user data from session
    } catch (error) {
        console.error("Error parsing user data:", error);
        return;
    }

    if (userData) {
        const userId = userData.id; // Retrieve user ID from session data

        // Fetch bikes for the user
        fetch(`http://localhost:8081/UserWebService/api/users/${userId}/bikes`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch bikes.");
                }
                return response.json();
            })
            .then(bikes => {
                sessionStorage.setItem("bikes", JSON.stringify(bikes));
                displayBikes(bikes);
            })
            .catch(error => {
                console.error("Error fetching bikes:", error);
                document.getElementById('bikes-container').innerHTML = `
                    <p style="color: red;">Unable to load your bikes. Please try again later.</p>`;
            });
    } else {
        console.error("No user data found in session.");
    }
});

function displayBikes(bikes) {
    const container = document.getElementById('bikes-container');
    container.innerHTML = ''; // Clear existing content

    if (bikes.length === 0) {
        container.innerHTML = '<p>No bikes found for this account.</p>';
        return;
    }

    bikes.forEach(bike => {
        const imageUrl = bike.images && bike.images.length > 0
            ? bike.images[0]
            : 'http://localhost:8081/UserWebService/css/images/imagevelo.jpg';

        const sellButton = bike.rented && bike.available
            ? `<a href="#" 
            		   onclick="sellBike(${bike.id})" 
            		   class="u-active-white u-align-center u-border-2 u-border-active-palette-1-base u-border-hover-palette-1-base u-border-green u-btn u-btn-round u-button-style u-hover-white u-green u-radius u-text-active-black u-text-body-alt-color u-text-hover-black u-btn-3"
            		   style="display: flex; align-items: center; justify-content: center;  margin: auto;  width: 200px;">
            		    <img src="css/images/sell-icon.png" alt="" style="margin-right: 8px; width: 20px; height: 20px;">
            		    Sell
            		</a>
`
            : ''; // Add Sell button only if bike.rented is true

        const bikeHTML = `
            <div class="u-list-item u-radius u-repeater-item u-shape-round u-white u-list-item-1" style="padding: auto;  margin-bottom:auto;">
                <div class="u-container-layout u-similar-container u-container-layout-1">
                    <img src="${imageUrl}" 
                        alt="Bike Image" 
                        class="u-expanded-width u-image u-image-round u-radius u-image-1" 
                        style="height: 200px; object-fit: cover;">
                    
                    <h5 class="u-align-center u-text u-text-3">${bike.model}</h5>
                    <p class="u-align-center u-text u-text-4">Brand: ${bike.brand}</p>
                    <p class="u-align-center u-text u-text-5">Condition: ${bike.condition}</p>
                    <p class="u-align-center u-text u-text-6">Color: ${bike.color}</p>
                    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
                    <a href="EditBike.html" onclick="editBike(${bike.id})" 
                        class="u-active-white u-align-center u-border-2 u-border-active-palette-1-base u-border-hover-palette-1-base u-border-palette-1-base u-btn u-btn-round u-button-style u-hover-white u-palette-1-base u-radius u-text-active-black u-text-body-alt-color u-text-hover-black u-btn-1" style="margin: 2px; margin-right: 5px padding: 10px 5px;" data-animation-name="" data-animation-duration="0" data-animation-delay="0" data-animation-direction="">
                        Edit Bike
                    </a>
                        
                    <!-- Delete Button -->
                    <a href="" onclick="deleteBike(${bike.id})" 
                        class="u-active-white u-align-center u-border-2 u-border-active-custom-color-3 u-border-custom-color-3 u-border-hover-custom-color-3 u-btn u-btn-round u-button-style u-custom-color-3 u-custom-item u-hover-white u-radius u-text-active-black u-text-body-alt-color u-text-hover-black u-btn-2" style="margin: 2px; margin-left: 5px padding: 10px 5px;">
                        <span class="u-file-icon u-icon u-text-custom-color-2 u-icon-2">
                        <img src="css/images/484611-0e0eab99.png" alt="" style="width: 16px; height: 16px;">
                        </span>&nbsp;Delete Bike
                    </a> 
                        
                    </div>
                    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
                    ${sellButton}
                    </div>
                </div>
            </div>`;
        container.innerHTML += bikeHTML;
    });
}

function deleteBike(bikeId) {
    // Confirm if the user wants to delete the bike
    const confirmDelete = confirm("Are you sure you want to delete this bike?");
    if (!confirmDelete) {
        return; // Exit if user cancels the delete action
    }

    // Retrieve user data from sessionStorage
    const userDataJson = sessionStorage.getItem("userData");
    let userData = null;

    try {
        userData = JSON.parse(userDataJson); // Parse user data
    } catch (error) {
        console.error("Error parsing user data:", error);
        alert("User is not logged in. Please log in first.");
        return;
    }

    if (!userData || !userData.id) {
        alert("User is not logged in. Please log in first.");
        return;
    }

    const userId = userData.id;

    // Send DELETE request to the server to remove the bike
    fetch(`http://localhost:8081/UserWebService/api/users/${userId}/bikes/${bikeId}`, 
    		{
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
        .then(response => {
            // Check if the response is successful
            if (!response.ok) {
                return response.text().then(errorMessage => {
                    throw new Error(errorMessage);
                });
            }
            return response.text(); // Expect a plain text response
        })
        .then(message => {
            alert(message); // Display the server's response

            // Remove the bike from the user's sessionStorage data
            if (userData.bikes) {
                userData.bikes = userData.bikes.filter(bike => bike.id !== bikeId);
                sessionStorage.setItem("userData", JSON.stringify(userData)); // Update sessionStorage
            }

            // Refresh the UI to reflect the deleted bike
            displayBikes(userData.bikes || []);
        })
        .catch(error => {
            console.error("Error deleting bike:", error);
            alert("Error deleting bike: " + error.message);
        });
}



function sellBike(bikeId) {
    const modal = document.getElementById('sell-modal');
    if (!modal) {
        console.error("Sell modal not found.");
        return;
    }

    const confirmButton = document.getElementById('confirm-sell-btn');
    const closeButton = document.getElementsByClassName('close-btn')[0];

    // Automatically set the sale start date to the current date
    const saleStartDateField = document.getElementById('sale-start-date');
    const currentDate = new Date().toISOString().split('T')[0]; // Format as YYYY-MM-DD
    saleStartDateField.value = currentDate;

    modal.style.display = 'block';

    // Close modal functionality
    closeButton.onclick = () => {
        modal.style.display = 'none';
    };

    // Confirm sale functionality
    confirmButton.onclick = async () => {
        // Get form inputs
        const saleTitle = document.getElementById('sale-title').value.trim();
        const saleDescription = document.getElementById('sale-description').value.trim();
        const saleDuration = document.getElementById('sale-duration').value.trim();
        const salePrice = document.getElementById('sell-price').value.trim();

        // Validate inputs
        if (!saleTitle || !saleDescription || !saleDuration || !salePrice) {
            alert("All fields are required. Please fill them out.");
            return;
        }

        const sale = {
            saleTitle,
            saleDescription,
            saleStartDate: saleStartDateField.value, // Use the system date
            duration: parseInt(saleDuration, 10), // Ensure proper data type
            salePrice: parseFloat(salePrice)     // Ensure proper data type
        };

        try {
        	const response = await fetch(`http://localhost:8081/UserWebService/api/sales/addSale?bikeId=${bikeId}`, {
        	    method: 'POST',
        	    headers: {
        	        'Content-Type': 'application/json'
        	    },
        	    body: JSON.stringify(sale)
        	});


            if (!response.ok) {
                const errorText = await response.text(); // Fetch server error message
                throw new Error(errorText || `Failed to add the sale. Status: ${response.status}`);
            }

            alert('Bike sold successfully!');
            modal.style.display = 'none';
            location.reload(); // Reload page to reflect changes
        } catch (error) {
            console.error("Error selling bike:", error);
            alert(`Error selling bike: ${error.message}`);
        }
    };

    // Close modal on clicking outside
    window.onclick = (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };
}
function editBike(bikeId) {
    // Fetch the list of bikes from sessionStorage
    const bikesJson = sessionStorage.getItem("bikes");
    
    if (!bikesJson) {
        alert("No bikes found in session. Please reload the page.");
        return;
    }

    const bikes = JSON.parse(bikesJson);

    // Find the selected bike by its ID
    const selectedBike = bikes.find(bike => bike.id === bikeId);

    if (!selectedBike) {
        alert("Bike not found.");
        return;
    }

    // Save the selected bike's details in sessionStorage for use in the edit page
    sessionStorage.setItem("selectedBike", JSON.stringify(selectedBike));

    // Redirect to the EditBike.html page
    window.location.href = "EditBike.html";
}

   
    document.addEventListener('DOMContentLoaded', () => {
        // Safely retrieve user data from session storage
        const userDataJson = sessionStorage.getItem("userData");
        let userData = null;

        try {
            userData = JSON.parse(userDataJson);
        } catch (error) {
            console.error("Error parsing user data:", error);
        }

        if (userData) {
            console.log("User data found in session:", userData);

            // Safely access and update DOM elements
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-link');
            const profileLink = document.getElementById('profile-link');
            const postsLink = document.getElementById('posts-link');
            const bikesLink = document.getElementById('Bikes-link');
            const rentalsLink = document.getElementById('rentals-link');
            const welcomeMessage = document.getElementById('welcome-message');

            if (loginBtn) loginBtn.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'block';
            if (profileLink) profileLink.style.display = 'block';
            if (postsLink) postsLink.style.display = 'block';
            if (bikesLink) bikesLink.style.display = 'block';
            if (rentalsLink) rentalsLink.style.display = 'block';
            if (welcomeMessage) welcomeMessage.textContent = `Welcome, ${userData.first_name}`;
        } else {
            console.log("No user data found in session.");
        }

        // Handle login button click
        const loginButton = document.getElementById('login-btn');
        if (loginButton) {
            loginButton.addEventListener('click', () => {
                window.location.href = "Login-Page.html";
            });
        }
        const logoutButton = document.getElementById('logout-btn');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                
                sessionStorage.clear();
                localStorage.clear();   
                
                window.location.href = "Login-Page.html";
            });
        }
    });

</script>

     <footer class="u-align-center u-clearfix u-container-align-center u-custom-color-1 u-footer u-footer" id="sec-5467"><div class="u-clearfix u-sheet u-sheet-1">
        <p class="u-small-text u-text u-text-variant u-text-1">© Developed By Eiffel Corp.</p>
      </div></footer>
</body>
</html>
