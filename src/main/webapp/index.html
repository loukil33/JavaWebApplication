<!DOCTYPE html>
<html style="font-size: 16px;" lang="en"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Rent your own bicycle​">
    <meta name="description" content="">
    <title>Home</title>
    <link rel="stylesheet" href="css/nicepage.css" media="screen">
<link rel="stylesheet" href="css/index.css" media="screen">
    <script class="u-script" type="text/javascript" src="css/js/jquery.js" defer=""></script>
    <script class="u-script" type="text/javascript" src="css/js/nicepage.js" defer=""></script>
    <meta name="generator" content="Nicepage 7.0.3, nicepage.com">
    <link id="u-theme-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i|Open+Sans:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i">
    <link id="u-page-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=ADLaM+Display:400">
    
    
    
    <style>
    .u-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    list-style: none;
    padding: 0;
    margin: 0;
}
.u-nav-item {
    margin: 0 10px;
}
.u-nav-link {
    text-decoration: none;
    padding: 10px 20px;
    color: black;
}
.u-nav-link:hover {
    color: blue;
}
.hidden {
    display: none;
}
/* Flexbox container for logo and navigation */
.navbar {
    display: flex;
    justify-content: space-between; /* Space between logo and navigation links */
    align-items: center; /* Vertically center the items */
    padding: 10px 20px;
}

/* Adjust the logo if necessary */
.u-logo {
    margin-right: 20px; /* Adjust space between the logo and the nav */
    margin-left: -10px; /* Move the logo slightly to the left */
}
.u-nav {
    display: flex; /* Keep the nav links in a row */
    list-style: none;
    padding: 0;
    margin: 0;
}

/* Ensure the logo image does not collapse */
.u-logo-image {
    max-height: 100px; /* Adjust the height for better scaling */
    max-width: auto; /* Ensure the aspect ratio is maintained */
    object-fit: contain; /* Fit the image within its container */
    margin-top: 45px;
}

.popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.popup-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    text-align: center;
}

.popup-content h3 {
    margin-top: 0;
}

.popup-content ul {
    text-align: left;
    list-style: none;
    padding: 0;
}

.popup-content button {
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #333;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.popup-content button:hover {
    background-color: #555;
}

    </style>
    <script type="application/ld+json">{
		"@context": "http://schema.org",
		"@type": "Organization",
		"name": "",
		"logo": "css/images/universite-gustave-eiffel.png"
}</script>
    <meta name="theme-color" content="#478ac9">
    <meta property="og:title" content="Home">
    <meta property="og:type" content="website">
  <meta data-intl-tel-input-cdn-path="intlTelInput/"></head>
  <body data-home-page="Home.html" data-home-page-title="Home" data-path-to-root="./" data-include-products="false" class="u-body u-xl-mode" data-lang="en">
  <header class="u-clearfix u-grey-5 u-header u-header" id="sec-4073">
  <div class="u-clearfix u-sheet u-valign-middle-xs u-sheet-1">


<nav class="navbar">
     <a href="#" class="u-image u-logo u-image-1" data-image-width="300" data-image-height="150">
    <img src="css/images/universite-gustave-eiffel.png" class="u-logo-image u-logo-image-1" alt="Université Gustave Eiffel Logo" style="width: auto; height: auto;">
</a>
    <ul class="u-nav u-unstyled u-nav-1">
        <li class="u-nav-item"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="index.html" style="padding: 10px 20px; margin-left: 80px;">Home</a></li>
        <li class="u-nav-item" id="profile-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="Page-1.html" style="padding: 10px 20px;">Profile</a></li>
        <li class="u-nav-item" id="Bikes-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="MyBikes.html" style="padding: 10px 20px;">My Bikes</a></li>
        <li class="u-nav-item" id="posts-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="Annonces.html" style="padding: 10px 20px;">My Posts</a></li>
        <li class="u-nav-item" id="rentals-link" style="display: none;"><a class="u-button-style u-nav-link u-text-active-grey-75 u-text-hover-palette-2-base" href="MyRentals.html" style="padding: 10px 20px;">My Rentals</a></li>
        <li class="u-nav-item" id="logout-link" style="display: none;">
            <button id="logout-btn" class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
                Logout
            </button>
            
        </li>
        <li class="u-nav-item" style="margin-left: 80px;">
        <button id="login-btn" class="u-border-none u-btn u-btn-round u-button-style u-hover-custom-color-1 u-palette-1-light-1 u-radius u-btn-1">
             Login
            </button>
            </li>
    </ul>
    <div id="user-info" style="display: none; margin-left: 20px; display: flex; align-items: center;">
    <h5 class="u-text u-text-default u-text-1" id="welcome-message"></h5>
    </div>
</nav>

                
</div></header>
    <section class="u-clearfix u-container-align-center u-image u-section-1" id="sec-9342" data-image-width="1728" data-image-height="972">
      <div class="u-clearfix u-sheet u-sheet-1"></div>
    </section>
    <section class="u-clearfix u-container-align-center-lg u-container-align-center-md u-container-align-center-xl u-container-align-center-xs u-palette-1-light-3 u-section-2" id="carousel_0d8e">
      <div class="u-clearfix u-sheet u-sheet-1">
        <h2 class="u-align-center u-custom-font u-text u-text-custom-color-1 u-text-default u-text-1" data-animation-name="customAnimationIn" data-animation-duration="1200" data-animation-delay="0">Rent your own bicycle </h2>
        <div class="u-expanded-width u-list u-list-1">
          <div class="u-repeater u-repeater-1" id="annonces-container-home">
            
          </div>
        </div>
      </div>
    </section>
    
    <script>
   
    document.addEventListener('DOMContentLoaded', () => {
        // Safely retrieve user data from session storage
        const userDataJson = sessionStorage.getItem("userData");
        let userData = null;

        try {
            userData = JSON.parse(userDataJson);
        } catch (error) {
            console.error("Error parsing user data:", error);
        }

        if (userData) {
            console.log("User data found in session:", userData);

            // Safely access and update DOM elements
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-link');
            const profileLink = document.getElementById('profile-link');
            const postsLink = document.getElementById('posts-link');
            const bikesLink = document.getElementById('Bikes-link');
            const rentalsLink = document.getElementById('rentals-link');
            const welcomeMessage = document.getElementById('welcome-message');

            if (loginBtn) loginBtn.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'block';
            if (profileLink) profileLink.style.display = 'block';
            if (postsLink) postsLink.style.display = 'block';
            if (bikesLink) bikesLink.style.display = 'block';
            if (rentalsLink) rentalsLink.style.display = 'block';
            if (welcomeMessage) welcomeMessage.textContent = `Welcome, ${userData.first_name}`;
            
            fetch( `http://localhost:8081/UserWebService/api/annonces/` 
    		)
    .then(response => {
        if (!response.ok) {
            throw new Error("Failed to fetch annonces.");
        }
        return response.json();
    })
    .then(annonces => {
        displayAnnoncesHome(annonces);
    })
    .catch(error => {
        console.error("Error fetching annonces:", error);
        document.getElementById('annonces-container-home').innerHTML = `
            <p style="color: red;">Unable to load your posts. Please try again later.</p>
            `;
    });
            
        } else {
            console.log("No user data found in session.");
        }

        // Handle login button click
        const loginButton = document.getElementById('login-btn');
        if (loginButton) {
            loginButton.addEventListener('click', () => {
                window.location.href = "Login-Page.html";
            });
        }
        const logoutButton = document.getElementById('logout-btn');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                
                sessionStorage.clear();
                localStorage.clear();   
                
                window.location.href = "Login-Page.html";
            });
        }

    });
    function displayAnnoncesHome(annonces) {
        const container = document.getElementById('annonces-container-home');
        container.innerHTML = ''; // Clear existing content

        if (annonces.length === 0) {
            container.innerHTML = '<p>No posts found.</p>';
            return;
        }

        annonces.forEach(annonce => {
            const userDataJson = sessionStorage.getItem("userData");
            let userData = null;

            try {
                userData = JSON.parse(userDataJson);
            } catch (error) {
                console.error("Error parsing user data:", error);
            }

            if (userData) {
                if (annonce.userid === userData.id) {
                    return;
                }
                

                let additionalInfo = "";
                fetch(`http://localhost:8081/UserWebService/api/users/${annonce.userid}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Failed to fetch username.");
                        }
                        return response.json();
                    })
                    .then(user => {
                        const username = user.last_name;

                        if ("rentPrice" in annonce) {
                            additionalInfo = `
                                <h4 class="u-align-center u-text u-text-palette-1-base u-text-3">${annonce.rentPrice} €/h</h4>
                                <p class="u-align-center u-text u-text-4"><strong>${annonce.bike.condition}</strong> ${annonce.bike.model} | ${annonce.bike.brand} | ${annonce.bike.color}</p>
                                <p class="u-align-center u-text u-text-5">
                                    <span class="u-file-icon u-icon u-icon-1">
                                        <img src="css/images/1584892.png" alt="" style="width: 20px; height: 20px; margin-bottom: 8px">
                                    </span>&nbsp;Rent Time: ${annonce.start_time} - ${annonce.end_time}
                                </p>`;
                        }

                        const imageUrl = annonce.bike.images && annonce.bike.images.length > 0
                            ? annonce.bike.images[0]
                            : 'http://localhost:8081/UserWebService/css/images/imagevelo.jpg';

                        const annonceHTML = `
                            <div class="u-list-item u-radius u-repeater-item u-shape-round u-white u-list-item-1" style="padding: auto;  margin-bottom:auto;" data-animation-name="customAnimationIn" data-animation-duration="1500" data-animation-delay="200">
                                <div class="u-container-layout u-similar-container u-container-layout-1">
                                    <img src="${imageUrl}" alt="" class="u-expanded-width u-image u-image-round u-radius u-image-1" data-image-width="1067" data-image-height="800">
                                    <h5 class="u-align-center u-text u-text-2">${annonce.title}</h5>
                                    <p class="u-align-center u-text u-text-4">${annonce.description}</p>
                                    ${additionalInfo}
                                    <blockquote class="u-align-center u-indent-9 u-text u-text-6" style="font-size: 12px; margin-bottom: 10px; color: #888;">Posted By ${username} ends in ${annonce.duration} days</blockquote>
                                    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
                                        <a href="#" onclick="RentBike(${annonce.id})" class="u-active-white u-align-center u-border-2 u-border-active-palette-1-base u-border-hover-palette-1-base u-border-palette-1-base u-btn u-btn-round u-button-style u-hover-white u-palette-1-base u-radius u-text-active-black u-text-body-alt-color u-text-hover-black u-btn-1" style="margin: 2px; margin-right: 5px padding: 10px 5px;" data-animation-name="" data-animation-duration="0" data-animation-delay="0" data-animation-direction="">Rent Bike</a>
                                        <a href="#" onclick="viewNotes(${annonce.id})" class="u-active-white u-align-center u-border-2 u-border-active-palette-1-base u-border-hover-palette-1-base u-border-palette-1-base u-btn u-btn-round u-button-style u-hover-white u-palette-1-base u-radius u-text-active-black u-text-body-alt-color u-text-hover-black u-btn-1" style="margin: 2px; margin-left: 5px; padding: 10px 5px;">View Notes</a>
                                    </div>
                                </div>
                            </div>
                        `;

                        container.innerHTML += annonceHTML;
                    })
                    .catch(error => {
                        console.error("Error fetching username:", error);
                    });
            }
        });
    }

    function viewNotes(annonceId) {
        fetch( ` http://localhost:8081/UserWebService/api/annonces/${annonceId}/notes `
        		)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch notes.");
                }
                return response.json();
            })
            .then(notes => {
                let popupHTML = "";
                if (!Array.isArray(notes)) {
        	        notes = []; // Initialize as an empty array if undefined
        	    }
                // Check if notes list is empty
                if (notes.length === 0) {
                    popupHTML = `
                        <div class="popup">
                            <div class="popup-content">
                                <h3>Post Comments</h3>
                                <p>There are no comments on this post.</p>
                                <button onclick="closePopup()">Close</button>
                            </div>
                        </div>
                    `;
                } else {
                    // If notes exist, display them
                    const notesList = notes.map(note => `
                        <li>
                            <strong>${note.username}:</strong> ${note.comment}<br>
                        </li>
                    `).join("");

                    popupHTML = `
                        <div class="popup">
                            <div class="popup-content">
                                <h3>Post Comments</h3>
                                <ul>${notesList}</ul>
                                <button onclick="closePopup()">Close</button>
                            </div>
                        </div>
                    `;
                }

                document.body.insertAdjacentHTML("beforeend", popupHTML);
            })
            .catch(error => {
                console.error("Error fetching notes:", error);
                alert("Error fetching notes.");
            });
    }

    // Close the popup
    function closePopup() {
        const popup = document.querySelector(".popup");
        if (popup) {
            popup.remove();  // Removes the popup from the DOM
        }
    }


    function RentBike(postId) {
        const userDataJson = sessionStorage.getItem("userData");
        if (!userDataJson) {
            alert("No user data found. Please log in.");
            return;
        }

        const userData = JSON.parse(userDataJson);
        if (userData.rentals && userData.rentals.includes(postId)) {
            showPopup("You have already rented this bike or are in the waiting list.");
            return;
        }
        fetch(`http://localhost:8081/UserWebService/api/rentals/${postId}/waiting-list`, 
        		{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to process rental request.");
                }
                return response.text();
            })
            .then(message => {
                console.log(message);
                alert(message);

                // If bike becomes available, check for next user
                if (message.includes("successfully rented")) {
                    if (!Array.isArray(userData.rentals)) {
                        userData.rentals = [];
                    }
                    userData.rentals.push(postId);
                    sessionStorage.setItem("userData", JSON.stringify(userData));
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error: " + error.message);
            });
    }
 // Function to display popup message
    function showPopup(message) {
        const popupHTML = `
            <div class="popup">
                <div class="popup-content">
                    <h3>${message}</h3>
                    <button onclick="closePopup2()">Close</button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML("beforeend", popupHTML);
    }

    // Function to close the popup
    function closePopup2() {
        const popup = document.querySelector('.popup');
        if (popup) {
            popup.remove();
        }
    }
    
</script>

    
    <footer class="u-align-center u-clearfix u-container-align-center u-custom-color-1 u-footer u-footer" id="sec-5467"><div class="u-clearfix u-sheet u-sheet-1">
        <p class="u-small-text u-text u-text-variant u-text-1">Sample text. Click to select the Text Element.</p>
      </div></footer>
   
  
</body></html>